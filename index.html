<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Entreate</title>
    <link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/lib/codemirror.min.css">
    <link rel="stylesheet" type="text/css" href="./entreate.css">

    <style>

      * {
        box-sizing: border-box;
        font-family: Verdana;
      }

      .content {
        margin: 0 auto;
        max-width: 900px;
      }

    </style>
  </head>

  <body>

    <div class='content'></div>

    <script src='https://cdn.jsdelivr.net/gh/gemdrive/gemdrive-auth-client@0.8.0/dist/umd.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/mode/markdown/markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js"></script>

    <script type='module'>

      import { Entreate } from './entreate.js';

      (async () => {

        if (window.opener) {
          window.addEventListener('message', (message) => {
            if (message.data.command === 'run') {
              render(message.data.items);
            }
          });

          window.opener.postMessage('child-ready');
        }
        else {
          render();
        }

      })();

      async function render(items) {

        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has('code') && urlParams.has('state')) {
          const { accessToken, state } = await window.gemdriveAuthClient.completeAuthorization();
          localStorage.setItem('access_token', accessToken);
        }

        const token = localStorage.getItem('access_token');

        let driveUri = urlParams.get('drive');
        if (!driveUri) {
          driveUri = prompt("Enter a drive URI");
          urlParams.set('drive', driveUri);
          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        let src = urlParams.get('src');
        if (!src) {
          src = prompt(`Enter a path to the source directory on ${driveUri}`);
          urlParams.set('src', src);
          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        let dst = urlParams.get('dst');
        if (!dst) {
          dst = prompt(`Enter a path to the destination directory on ${driveUri}`);
          urlParams.set('dst', dst);
          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        const entreateEl = Entreate(driveUri, src, dst, token);

        entreateEl.addEventListener('do-auth', (e) => {
          gemdriveAuthClient.authorize({
            driveUri,
            perms: [
              {
                type: 'dir',
                perm: 'write',
                path: src,
              },
              {
                type: 'dir',
                perm: 'write',
                path: dst,
              },
            ],
            state: driveUri,
          });
        });

        const content = document.querySelector('.content');
        content.appendChild(entreateEl);
      }

    </script>
  </body>

</html>
