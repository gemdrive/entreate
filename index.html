<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GemDrive Entreate</title>
    <link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/lib/codemirror.min.css">
    <link rel="stylesheet" type="text/css" href="./entreate.css">

    <style>

      * {
        box-sizing: border-box;
        font-family: Verdana;
      }

      .content {
        margin: 0 auto;
        max-width: 900px;
      }

    </style>
  </head>

  <body>

    <div class='content'></div>

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.56.0/mode/markdown/markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js"></script>

    <script type='module'>

      import { Entreate } from './entreate.js';

      (async () => {

        if (window.opener) {
          window.addEventListener('message', (message) => {
            if (message.data.command === 'run') {
              render(message.data.items);
            }
          });

          window.opener.postMessage('child-ready');
        }
        else {
          render();
        }

      })();

      async function render(items) {

        const urlParams = new URLSearchParams(window.location.search);

        const token = localStorage.getItem('access_token');

        let driveUri = urlParams.get('drive');
        if (!driveUri) {
          driveUri = prompt("Enter a drive URI");
          urlParams.set('drive', driveUri);
          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        let src = urlParams.get('src');
        if (!src) {
          src = prompt(`Enter a path to the source directory on ${driveUri}`);
          urlParams.set('src', src);
          history.pushState(null, '', window.location.pathname + '?' + decodeURIComponent(urlParams.toString()));
        }

        const entreateEl = Entreate(driveUri, src, token);

        entreateEl.addEventListener('do-auth', async (e) => {
          const email = prompt("Enter email to authorize:");
          const code = Math.floor(Math.random() * 1000);

          const res = await fetch(driveUri + src + `.gemdrive-auth?id=${email}&perm=own&code=${code}`, {
            method: 'POST',
          });

          if (res.status === 200) {
            const accessToken = await res.text();
            localStorage.setItem('access_token', accessToken);
            alert("Successfully authorized");
            window.location.reload();
          }
          else {
            alert("Authorization failed");
          }
        });

        const content = document.querySelector('.content');
        content.appendChild(entreateEl);
      }

    </script>
  </body>

</html>
